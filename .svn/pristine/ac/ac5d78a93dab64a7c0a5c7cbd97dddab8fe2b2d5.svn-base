<?php

class ThemeCollector {
    const CONF_THEME = 'theme';
    const CONF_CSS_CLASS = 'css-class';
    const CONF_RENDERER = 'renderer-file';
    const CONF_RENDERER_CLASS = 'renderer-class';
    
    const KEY_CSS = 'css';
    const KEY_RENDERER_F = 'rend-f';
    const KEY_RENDERER = 'rend-c';
    
    private function createThemeConf($themeInfo, $dir, &$themes) {
        if ($themeInfo[self::CONF_THEME] != $dir) {
            return false;
        } else {
            $theme = $themeInfo[self::CONF_THEME];
        }
        $themes[$theme] = array();
        
        if (!isset($themeInfo[self::CONF_CSS_CLASS])) {
            return false;
        }
        $themes[$theme][self::KEY_CSS] = $themeInfo[self::CONF_CSS_CLASS];
        
        
        
        
        return true;
    }
    
    private function addTheme($dirPath, $dir, $collecton, &$themes) {
        if (!file_exists($dirPath."/theme.info.txt")) {
            return;
        }
        $themeConf = confToHash($dirPath."/theme.info.txt", true);
        
        

        echo "<pre>".var_dump($themeConf)."</pre>";
        echo $dirPath."<br/>";
        
        if ($themeConf['theme'] != $dir) {
            return;
        }
        
        if (file_exists($dirPath."/screen.css")) {
            $css = $this->css_loadfile($dirPath."/screen.css", "/lib/plugins/smartindex/themes/{$dir}/");
            //@fwrite($file, file_get_contents($dirPath."/screen.css")."\n");
            @fwrite($file, $css);
        }
        
    }
    
    private function addCssFile($collection, $filePath) {
        if (file_exists($filePath)) {
            $css = css_loadfile($filePath, $themesURL);
            @fwrite($collection, $css);
        }
    }
    
    public function collect() {
        $collection = fopen(SMARTINDEX_DIR.'screen.css', 'w');
        $this->addCssFile($collection, THEMES_DIR.'screen.css');
        
        $themes = array();
        $dh = @opendir(THEMES_DIR);
        if (!$dh) return;
        while(($file = readdir($dh)) !== false) {
            if(preg_match('/^[\._]/',$file)) 
                    continue;
            $filePath = THEMES_DIR.$file;
            if(is_dir($filePath)){
                $this->addTheme($filePath, $file, $collection, $themes);
            }
        }
        @fclose($collection);
        
        echo "<pre>".var_dump($themes)."</pre>";
        closedir($dh);
    }
}
