<?php

class ThemeCollector {
    const CONF_THEME = 'theme';
    const CONF_CSS_CLASS = 'css-class';
    const CONF_RENDERER = 'renderer-file';
    const CONF_RENDERER_CLASS = 'renderer-class';
    
    const KEY_CSS = 'css';
    const KEY_RENDERER_F = 'rend-f';
    const KEY_RENDERER = 'rend-c';
    
    private $themesDir;
    
    private function css_loadfile($file,$location=''){
        if(!@file_exists($file)) return '';
        $css = file_get_contents($file);
        if(!$location) return $css;

        $css = preg_replace('#(url\([ \'"]*)(?!/|data:|http://|https://| |\'|")#','\\1'.$location,$css);
        $css = preg_replace('#(@import\s+[\'"])(?!/|data:|http://|https://)#', '\\1'.$location, $css);

        return $css;
    }
    

    private function createThemeConf($themeInfo, $dir, &$themes) {
        if ($themeInfo[self::CONF_THEME] != $dir) {
            return false;
        } else {
            $theme = $themeInfo[self::CONF_THEME];
        }
        $themes[$theme] = array();
        
        if (!isset($themeInfo[self::CONF_CSS_CLASS])) {
            return false;
        }
        $themes[$theme][self::KEY_CSS] = $themeInfo[self::CONF_CSS_CLASS];
        
        
        
        
        return true;
    }
    
    private function addTheme($dirPath, $dir, $file, &$themes) {
        if (!file_exists($dirPath."/theme.info.txt")) {
            return;
        }
        $themeConf = confToHash($dirPath."/theme.info.txt", true);
        
        

        echo "<pre>".var_dump($themeConf)."</pre>";
        echo $dirPath."<br/>";
        
        if ($themeConf['theme'] != $dir) {
            return;
        }
        
        if (file_exists($dirPath."/screen.css")) {
            $css = $this->css_loadfile($dirPath."/screen.css", "/lib/plugins/smartindex/themes/{$dir}/");
            //@fwrite($file, file_get_contents($dirPath."/screen.css")."\n");
            @fwrite($file, $css);
        }
        
    }
    
    public function collect($themesDir) {
        global $conf;
        
        $this->themesDir = $themesDir;
        $themesURL = DOKU_BASE.'lib/plugins/smartindex/themes/';
        
        $dh = @opendir($themesDir);

        $cssFile = fopen($themesDir.'/../screen.css', 'w');
        if (file_exists($themesDir."/screen.css")) {
            $css = $this->css_loadfile($themesDir."/screen.css", $themesURL);
            @fwrite($cssFile, $css);
        }
        
        $themes = array();
        if (!$dh) return;
        while(($file = readdir($dh)) !== false){
            if(preg_match('/^[\._]/',$file)) continue;
            $filePath = $themesDir.'/'.$file;
            if(is_dir($filePath)){
                $this->addTheme($filePath, $file, $cssFile, $themes);
            }
        }
        @fclose($file);
        closedir($dh);
    }
}
