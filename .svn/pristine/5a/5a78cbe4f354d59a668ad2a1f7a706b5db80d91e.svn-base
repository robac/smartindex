<?php

class SmartIndexConf {
    const TREE_CLASS = 'smartindex-treeview';
    const HIGHLITE_CLASS = 'smartindex-highlite';
    const THEME_CLASS_PATTERN = 'smartindex-{theme}-theme';
    
    const PARAM_NAMESPACE = 'namespace';
    const PARAM_DEPTH = 'depth';
    const PARAM_NS_PAGE = 'nspage';
    const PARAM_HIGHLITE = 'highlite';
    const PARAM_THEME = 'theme';
    const PARAM_AJAX_DEPTH = 'ajaxdepth';
    
    public $namespace = '';
    public $highlite = true;
    public $baseDir = NULL;
    public $depth = 1;
    public $followPath = '';
    public $treeId = NULL;
    public $nsPage = 'start';
    public $theme = 'default';
    public $ajaxDepth = NULL;
    
    public $error = NULL;
    
    public function readFromTag($match) {
        $params = substr($match, 12, strlen($match)-14);
        preg_match_all('/([a-zA-Z\-]+)\s*=\s*"([^"]*)"/i',$params, $res, PREG_SET_ORDER);
        foreach ($res as $val) {
            switch (strtolower($val[1])) {
                case self::PARAM_NAMESPACE:
                    $this->namespace = $val[2];
                    break;
                
                case self::PARAM_DEPTH:
                    $this->depth = $val[2];
                    break;
                    
                case self::PARAM_NS_PAGE:
                    $this->nsPage = $val[2];
                    break;
                    
                case self::PARAM_THEME:
                    $this->theme = $val[2];
                    break;
                    
                case self::PARAM_HIGHLITE:
                    $this->highlite = Utils::parseBoolean($val[2]);
                    break;
                
                default:
                    $this->error = "invalid param {$val[1]}";
            }
            
        }
    }
    
    private function createThemeClass($theme) {
        return str_replace('{theme}', $theme, self::THEME_CLASS_PATTERN);
    }
    
    public function checkHandle() {
        global $conf;
        
        if (is_null($this->baseDir)) {
            $this->baseDir = $conf['datadir'];
        }
        
        if ($this->depth < 1) {
            $this->error = "Chyba recLevel";
        }
        
        if (is_null($this->highlite)) {
            $this->error = "chyba highlite";
        }
        
        if (is_null($this->ajaxDepth)) {
            $this->ajaxDepth = $this->depth;
        }
        
        $this->theme = $this->createThemeClass($this->theme);
    }
    
    public function checkRender() {
        if (is_null($this->treeId)) {
            $this->treeId = Utils::getFloatMicrotime("smartindex_");
        }
    }
    
}