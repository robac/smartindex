<?php
/**
 * DokuWiki Plugin test (Syntax Component)
 *
 * @license GPL 2 http://www.gnu.org/licenses/gpl-2.0.html
 * @author  robert poch <robik@poch.cz>
 */

// must be run within Dokuwiki
if (!defined('DOKU_INC')) die();

if (!defined('DOKU_LF')) define('DOKU_LF', "\n");
if (!defined('DOKU_TAB')) define('DOKU_TAB', "\t");
if (!defined('DOKU_PLUGIN')) define('DOKU_PLUGIN',DOKU_INC.'lib/plugins/');

require_once DOKU_PLUGIN.'syntax.php';


function smartindex_autoloader($class) {
    $classpath = dirname(__FILE__).DIRECTORY_SEPARATOR.'classes'.DIRECTORY_SEPARATOR."{$class}.php"; 
    if (file_exists($classpath)) {
        require_once $classpath;
    }
}

spl_autoload_register('smartindex_autoloader');


class syntax_plugin_smartindex extends DokuWiki_Syntax_Plugin {
    public function getType() {
        return 'substition';
    }

    public function getPType() {
        return 'block';
    }

    public function getSort() {
        return 100;
    }


    public function connectTo($mode) {
        //$this->Lexer->addSpecialPattern('<smartindex>', $mode, 'plugin_smartindex');
        $this->Lexer->addSpecialPattern('<smartindex .+?/>', $mode, 'plugin_smartindex');
        
    }


    public function handle($match, $state, $pos, &$handler){
        $data = $match;
        return $data;
    }
    
    public function removeDirs($dir, $filename) {
        return str_replace("\\", ":", substr($filename, strlen($dir)+1));
    }
    
    private function processConfig($match, SmartIndexConf $config) {
        $conf = substr($match, 12, strlen($match)-14);
        preg_match_all('/([a-z]+)="([^"]*)"/i',$conf, $res, PREG_SET_ORDER);
        foreach ($res as $val) {
            if ($val[1]=="namespace") {
                $config->namespace = $val[2];
            }
        }
    }
            
    

    public function render($mode, &$renderer, $data) {
        global $conf;
        global $INFO;
        
        if($mode != 'xhtml') 
            return false;

        $config = new SmartIndexConf();
        $this->processConfig($data, $config);

        $config->recursionLevel = 2;
        $config->followPath = $INFO['id']; 
        $config->check();
        
        if (is_null($config->error)) {
            $seeker = new PageSeeker($config);
            $pages = $seeker->get($config);
        } else {
            $renderer->doc .= "error";
        }
            
        
        $indexBuilder = new SmartIndexRenderer($config);
        $indexBuilder->setUseWrapper(true, $config->treeId, array("smartindex-treeview smartindex-default"));
        $indexBuilder->render($pages, $renderer->doc);
               
        return true;
    }
}
