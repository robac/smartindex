function getParameterByName(url, name)
{
  name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
  var regexS = "[\\?&]" + name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  var results = regex.exec(url);
  if(results == null)
    return "";
  else
    return decodeURIComponent(results[1].replace(/\+/g, " "));
}

function getSmartIndexConf(tree) {
        return window[jQuery(tree).attr('id')+'_conf'];
}

function SmartIndexOpenFolder(event) {
        var link = jQuery(this).children("a");
        if (link.parent().siblings("ul").length == 0) {
            if (link.parent().parent().hasClass("waiting")) {
                return false;
            }
            link.parent().parent().addClass("waiting");
            jQuery.post(event.data.url, {namespace: getParameterByName(link.attr('href'), 'idx'), depth: event.data.depth, theme: event.data.theme}, function(data){
                link.parent().parent().append(data);
                link.parent().parent().removeClass("waiting");
            });
        }
        link.parent().parent().removeClass('closed').addClass('open');
        return false;
}

function SmartIndexCloseFolder(event) {
    jQuery(this).parent().removeClass('open').addClass('closed');
    return false;
}

function SmartIndexDivLink(event) {
        window.location = jQuery(this).children('a').attr('href');
        return false;
}


function initSmartIndexTree(tree) {
    var conf = getSmartIndexConf(tree);
    var id = jQuery(tree).attr('id');
    jQuery.each(conf.openActions, function(key, value){
        jQuery(tree).delegate('#'+id+' '+value.selector, value.event, conf, window[value.func]);
    });
}

function initSmartIndex() {
    jQuery.each(jQuery('div.smartindex-treeview'), function(key, value){
        initSmartIndexTree(value);
    });
}

jQuery(function(){
    initSmartIndex();
});

/*jQuery(function(){
    jQuery.contextMenu({
        selector: '#dokuwiki__site',
        callback: function(key, options) {
            var m = "clicked: " + key;
            window.console && console.log(m) || alert(m); 
        },
        items: {
            "edit": {"name": "Edit", "icon": "edit"},
            "cut": {"name": "Cut", "icon": "cut"},
            "sep1": "---------",
            "quit": {"name": "Quit", "icon": "quit"},
            "sep2": "---------",
            "fold1": {
                "name": "Sub group", 
                "items": {
                    "fold1-key1": {"name": "Foo bar"},
                    "fold2": {
                        "name": "Sub group 2", 
                        "items": {
                            "fold2-key1": {"name": "alpha"},
                            "fold2-key2": {"name": "bravo"},
                            "fold2-key3": {"name": "charlie"}
                        }
                    },
                    "fold1-key3": {"name": "delta"}
                }
            },
            "fold1a": {
                "name": "Other group", 
                "items": {
                    "fold1a-key1": {"name": "echo"},
                    "fold1a-key2": {"name": "foxtrot"},
                    "fold1a-key3": {"name": "golf"}
                }
            }
        }
    });
});*/

(function($){
function setupContext(settings) {
    var text = "<ul class=\"jeegoocontext cm_poch\" id=\""+settings.id+"\">";
    $.each(settings.items, function(key, value){
        var x = "<span class=\"icon "+value.icon+"\"></span>";
        text += "<li"+((value.icon != null)?" class=\"icon\">"+x:">")+value.text+"<ul><li>pokus</li><li>pokus2</li></ul></li>";
    });
    text += "</ul>";
    
    $('body').append(text);
    
    var all = {
        widthOverflowOffset: 0,
        heightOverflowOffset: 3,
        submenuLeftOffset: -4,
        submenuTopOffset: 0,
        onSelect: settings.onSelect
    };
    
    $.each(settings.selectors, function(key, value){
        all.event = value.event;
        $(value.selector).jeegoocontext(settings.id, all);
    });
}

$(function() {
    var set = {
        "id" : "menu1", 
        "selectors" : [
            {"selector" : ".pochva", event : "click"},
            {"selector" : ".smartindex-treeview", event : "contextmenu"},
            {"selector" : ".pageId", event : "contextmenu"}
        ],
        "items": [
            {text : "hello", icon: "file"}, 
            {text : "poch",  icon: "drive"}
        ],
        onSelect: function(e, context) {
            alert(jQuery(context).html());
        }
    };

    setupContext(set);
});
})(jQuery);
    
